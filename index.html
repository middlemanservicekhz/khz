<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KHZ Middleman Service | Secure Gaming Account Intermediary</title>
  <meta name="description" content="Professional middleman service for gaming and digital accounts. Secure, transparent and reliable transactions." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
  :root{
    --bg:#0b0f14;
    --card:#121826;
    --muted:#9aa4b2;
    --text:#e6ebf2;
    --accent:#4f7cff;
    --accent2:#2bd4bd;
    --radius:16px;
    --shadow:0 10px 30px rgba(0,0,0,.35);
    /* Nuevas variables para el chat estilo ElDorado */
    --chat-me: linear-gradient(135deg, var(--accent), #3a66e5);
    --chat-them: #1c253d;
    --chat-mm: linear-gradient(135deg, var(--accent2), #24a898);
  }

  .review{
    transition: transform .2s ease, box-shadow .2s ease;
  }

  .review:hover{
    transform: translateY(-4px);
    box-shadow: 0 14px 40px rgba(0,0,0,.45);
  }

  .review .verified{
    margin-bottom: 6px;
  }

  *{box-sizing:border-box}
  html,body{
    margin:0;
    background:
      radial-gradient(1200px 600px at 10% -10%, #15203b 0%, transparent 60%),
      radial-gradient(900px 500px at 90% 10%, #0f3a2f 0%, transparent 55%),
      var(--bg);
    color:var(--text);
    font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  a{color:inherit; text-decoration:none}

    html,body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #15203b 0%, transparent 60%), radial-gradient(900px 500px at 90% 10%, #0f3a2f 0%, transparent 55%), var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial}
    a{color:inherit; text-decoration:none}
    .container{max-width:1200px; margin:0 auto; padding:28px}
    header{position:sticky; top:0; z-index:5; backdrop-filter:saturate(1.2) blur(10px); background:linear-gradient(to bottom, rgba(11,15,20,.85), rgba(11,15,20,.55)); border-bottom:1px solid rgba(255,255,255,.06)}
    .nav{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .brand{display:flex; align-items:center; gap:12px}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent2)); box-shadow:var(--shadow)}
    .brand strong{font-weight:800}
    .actions{display:flex; gap:12px}
    .btn{padding:12px 18px; border-radius:14px; background:linear-gradient(135deg, var(--accent), #6a8bff); color:white; font-weight:600; box-shadow:var(--shadow); border:0; cursor:pointer}
    .btn.secondary{background:#1b2336; color:var(--text); border:1px solid rgba(255,255,255,.08)}

    .hero{display:grid; grid-template-columns:1.2fr .8fr; gap:28px; padding:64px 0}
    .hero h1{font-size:44px; line-height:1.1; margin:0 0 14px}
    .hero p{color:var(--muted); font-size:18px}
    .hero-card{background:linear-gradient(180deg, #121826, #0f1422); border-radius:var(--radius); padding:24px; box-shadow:var(--shadow)}

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:18px}
    .card{background:linear-gradient(180deg, #121826, #0f1422); border-radius:var(--radius); padding:22px; box-shadow:var(--shadow)}
    .card h3{margin:0 0 6px}
    .card p{margin:0; color:var(--muted)}

    .section{padding:56px 0}
    .section h2{
  font-size:34px;
  margin:0 0 10px;
  letter-spacing:-0.5px;
}

    .section .sub{color:var(--muted); margin-bottom:26px}

    .games{display:flex; flex-wrap:wrap; gap:10px}
    .pill{padding:8px 12px; border-radius:10px; background:#10172a; border:1px solid rgba(255,255,255,.08)}

    .testimonials{display:grid; grid-template-columns:repeat(4,1fr); gap:20px}
    .review{background:#0f1628; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px}
    .profile{display:flex; gap:10px; align-items:center}
    .avatar{width:36px; height:36px; border-radius:50%}
    .name{font-weight:600}
    .date{font-size:11px;color:var(--muted);margin-top:2px}
    .review p{color:#cbd5e1; margin:8px 0 0; font-size:14px}
    .verified{display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#7cf5c2; background:rgba(43,212,189,.12); border:1px solid rgba(43,212,189,.35); padding:4px 8px; border-radius:999px; margin-top:4px}

    #pagination button{cursor:pointer}

    footer{border-top:1px solid rgba(255,255,255,.08); padding:28px 0; color:var(--muted)}

    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .testimonials{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width: 520px){
      .testimonials{grid-template-columns:1fr}
      .hero h1{font-size:34px}
    }
.hero{
  align-items:center;
}

.hero h1{
  background: linear-gradient(135deg, #ffffff, #9fb5ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}.btn{
  transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
}

.btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(79,124,255,.45);
}

.btn.secondary:hover{
  background:#232c45;
}.hero-card{
  position: relative;
  overflow: hidden;
}

.hero-card::before{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg, transparent, rgba(79,124,255,.15), transparent);
  opacity:.6;
}

.hero-card:hover{
  transform: translateY(-4px);
  box-shadow: 0 18px 45px rgba(0,0,0,.5);
}header{
  box-shadow: 0 10px 30px rgba(0,0,0,.25);
}

header .btn{
  padding:10px 16px;
  border-radius:12px;
}.section{
  padding:72px 0;
}

.section + .section{
  border-top:1px solid rgba(255,255,255,.04);
}.section:nth-of-type(even){
  background: rgba(255,255,255,.02);
  border-radius: 24px;
  padding-left: 32px;
  padding-right: 32px;
}.section h2::after{
  content:"";
  display:block;
  width:48px;
  height:3px;
  margin-top:10px;
  border-radius:2px;
  background: linear-gradient(90deg, var(--accent), var(--accent2));
}.pill{
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
}

.pill:hover{
  transform: translateY(-2px);
  background:#162040;
  box-shadow: 0 8px 20px rgba(0,0,0,.35);
}.review p{
  line-height:1.6;
}

.review{
  position:relative;
}

.review::before{
  content:"‚Äú";
  position:absolute;
  top:8px;
  left:10px;
  font-size:48px;
  color:rgba(255,255,255,.08);
  pointer-events:none;
}
footer{
  background: linear-gradient(180deg, rgba(255,255,255,.02), transparent);
}

footer .container{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}

@media (max-width:520px){
  footer .container{
    flex-direction:column;
    text-align:center;
  }
}

.logo{
  width:40px;
  height:40px;
  border-radius:12px;
  background: transparent; /* üëà QUITA EL CUADRO AZUL */
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}

.logo img{
  width:100%;
  height:100%;
  object-fit:contain; /* usa cover si quieres que llene todo */
}

#quickReviews {
  overflow-x: auto; /* Permite desplazamiento horizontal si se salen del √°rea */
  white-space: nowrap; /* Evita que los elementos se acomoden en varias l√≠neas */
}/* ===== SCROLL PREMIUM GLOBAL ===== */

html {
  scroll-behavior: smooth;
}

/* Chrome / Edge / Safari */
*::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

*::-webkit-scrollbar-track {
  background: transparent;
}

*::-webkit-scrollbar-thumb {
  background-color: rgba(255,255,255,.22);
  border-radius: 10px;
}

*::-webkit-scrollbar-thumb:hover {
  background-color: rgba(255,255,255,.4);
}

/* Firefox */
* {
  scrollbar-width: thin;
  scrollbar-color: rgba(255,255,255,.35) transparent;
}/* ===== FOOTER COMPACTO Y ORDENADO ===== */

footer .container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  letter-spacing: 0.4px;
  opacity: 0.85;
}

/* HOW IT WORKS ‚Äì final layout */
.how-grid {
  display: grid;
  grid-template-columns: repeat(3, minmax(280px, 1fr));
  gap: 40px;
  margin-top: 48px;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}

.how-grid .card {
  padding: 32px;
  min-height: 160px;
}

.how-grid .card h3 {
  font-size: 18px;
  margin-bottom: 10px;
}

.how-grid .card p {
  font-size: 15px;
  opacity: 0.85;
  line-height: 1.5;
}

/* Tablet */
@media (max-width: 1024px) {
  .how-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
/* Mobile */
@media (max-width: 640px) {
  .how-grid {
    grid-template-columns: 1fr;
  }
}
h1, h2 {
  background: linear-gradient(90deg, #7c7cff, #00ffe1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
body {
  color: #d1d5db; /* gris claro profesional */
}

/* Global text color override */
p,
.section p,
.card p,
li,
span {
  color: #d1d5db;
}
.image-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  inset: 0;
  background: rgba(0, 0, 0, 0.9);
  justify-content: center;
  align-items: center;
}


.image-modal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
}

.image-modal .close {
  position: absolute;
  top: 24px;
  right: 32px;
  font-size: 32px;
  color: white;
  cursor: pointer;
}
/* Im√°genes clickeables */
img:not(.avatar) {
  cursor: pointer;
}
/* ===============================
   CHAT HEADER BUTTONS POSITION
   =============================== */

#minimizeChatBtn {
  position: relative;
  top: -6px;       /* üëà s√∫belo (ajusta 12‚Äì16 si quieres) */
  right: 8px;     /* separaci√≥n respecto a la X */
  cursor: pointer;
}

#closeChatBtn {
  position: relative;
  top: 4px;
  right: 16px;
  cursor: pointer;
}
/* How it works ‚Äì balanced spacing */
.section.how .sub {
  margin-bottom: 18px;
}

.section.how .how-grid {
  margin-top: 22px;
}

/* ===== HOW IT WORKS ‚Äì card hover ===== */
.how-grid .card {
  transition: transform .25s ease, box-shadow .25s ease, border-color .25s ease;
  border: 1px solid rgba(255,255,255,.08);
}

.how-grid .card:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 45px rgba(0,0,0,.55);
  border-color: rgba(43,212,189,.55);
}
/* Move How it works section up */
.section.how {
  padding-top: 36px;
}
/* Keep normal arrow cursor on How cards */
.how-grid .card,
.how-grid .card * {
  cursor: default;
}
/* Footer year fix */
footer #year {
  color: inherit;
  font-size: inherit;
  font-weight: inherit;
}
/* Fix year dash alignment */
footer .year-range {
  letter-spacing: 0.3px;
}
/* ===== ORDER PANEL ===== */

#orderPanel{
  background:#0b1220;
  border:1px solid #1f2a44;
  border-radius:12px;
  padding:12px;
  margin:10px 0;
  font-size:13px;
}

.order-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.order-header span{
  font-size:11px;
  padding:4px 8px;
  border-radius:999px;
  background:#1b2336;
  color:#9aa4b2;
}

.order-info{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
}

.label{
  font-size:11px;
  color:#9aa4b2;
  display:block;
}

#orderSteps{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}

.step{
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  background:#1b2336;
  color:#9aa4b2;
  border:1px solid rgba(255,255,255,.08);
}
.step.active{
  background:rgba(43,212,189,.15);
  color:#2bd4bd;
  border-color:rgba(43,212,189,.4);
}

.step.done{
  background:rgba(79,124,255,.15);
  color:#7c9cff;
}
/* Estilos para el modal (popup) */
.modal {
  display: none; /* Por defecto oculto */
  position: fixed;
  z-index: 1000; /* Aumentado para asegurar que est√© arriba */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7); /* Fondo un poco m√°s oscuro para m√°s profesionalismo */
  backdrop-filter: blur(4px); /* Efecto blur moderno */
  padding-top: 60px;
}

/* Estilo del contenido del modal */
.modal-content {
  background-color: #121826;
  margin: 5% auto;
  padding: 30px;
  border-radius: 16px;
  width: 90%;
  max-width: 450px;
  color: #fff;
  font-size: 14px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255,255,255,0.05);
  position: relative;
}

/* Estilo del bot√≥n de cerrar */
.close-btn {
  color: #aaa;
  font-size: 24px;
  font-weight: bold;
  position: absolute;
  top: 15px;
  right: 20px;
  cursor: pointer;
  transition: color 0.2s;
}

.close-btn:hover {
  color: #fff;
}

/* Estilo de los inputs y el select */
.form-input {
  padding: 12px;
  background: #1b2336;
  border-radius: 10px;
  color: #fff;
  border: 1px solid rgba(255,255,255,0.1);
  width: 100%;
  margin-bottom: 20px;
  font-family: inherit;
  transition: border-color 0.3s;
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  background: #232c45;
}

/* Estilo del bot√≥n de confirmaci√≥n */
.submit-btn {
  padding: 14px;
  background: linear-gradient(135deg, var(--accent2), #24a898);
  color: #fff;
  border: none;
  border-radius: 10px;
  width: 100%;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(43,212,189,0.3);
}

/* Estilo del popup */
.chat-popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  z-index: 3000;
}

.popup-content {
  background: #121826;
  border-radius: 16px;
  padding: 30px;
  color: white;
  text-align: center;
  max-width: 400px;
  width: 90%;
  border: 1px solid rgba(255,255,255,0.1);
  box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}
/* =========================
   CHAT STYLE ‚Äî ELDORADO BASE
   ========================= */

.chat-overlay {
  position: fixed;
  inset: 0;
  background: rgba(10, 14, 25, 0.85); /* Un poco m√°s profundo */
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(8px);
}

.chat-window {
  width: 440px; /* Un poco m√°s ancho para legibilidad */
  height: 650px;
  background: var(--chat-bg); 
  border-radius: 20px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 40px 100px rgba(0,0,0,0.7);
  font-family: inherit;
  border: 1px solid rgba(255,255,255,0.08);
  overflow: hidden;
}

/* HEADER */
.chat-header {
  padding: 16px 20px;
  background: rgba(255,255,255,0.02);
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
}

.chat-header-actions {
  display: flex;
  gap: 12px;
}

.chat-header-actions button {
  background: rgba(255,255,255,0.05);
  border: none;
  color: #9aa4b2;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}

.chat-header-actions button:hover {
  background: rgba(255,255,255,0.1);
  color: #fff;
}

/* ORDER PANEL */
#orderPanel {
  padding: 16px;
  background: rgba(79, 124, 255, 0.03);
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

.order-info {
  display: flex;
  justify-content: space-between;
  font-size: 13px;
  color: #fff;
}

.order-info .label {
  display: block;
  font-size: 11px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 2px;
}

#orderSteps {
  display: flex;
  gap: 8px;
  margin-top: 14px;
}

.step {
  flex: 1;
  text-align: center;
  padding: 6px 0;
  font-size: 10px;
  font-weight: 700;
  border-radius: 6px;
  background: rgba(255,255,255,0.05);
  color: #64748b;
  text-transform: uppercase;
}

.step.active {
  background: rgba(43, 212, 189, 0.15);
  color: var(--accent2);
  border: 1px solid rgba(43, 212, 189, 0.3);
}

.step.done {
  background: rgba(79, 124, 255, 0.15);
  color: var(--accent);
}

/* MESSAGES CONTAINER */
.chat-messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background-image: radial-gradient(rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 20px 20px;
}

/* MENSAJES ESTILO ELDORADO */
.msg {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  position: relative;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Mi mensaje (Comprador/Vendedor) */
.msg.me {
  background: var(--chat-me);
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

/* Mensaje de la otra parte */
.msg.them {
  background: var(--chat-them);
  color: #e5e7eb;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  border: 1px solid rgba(255,255,255,0.05);
}

/* MENSAJE MIDDLEMAN (Destacado) */
.msg.middleman {
  background: var(--chat-mm);
  color: #fff;
  align-self: center;
  text-align: center;
  font-weight: 500;
  border-radius: 12px;
  max-width: 90%;
  border: 1px solid rgba(255,255,255,0.1);
}

/* INPUT BAR */
.chat-input-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 16px;
  background: #0f172a;
  border-top: 1px solid rgba(255,255,255,0.06);
}

.chat-input-bar input {
  flex: 1;
  background: #020617;
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 10px;
  padding: 12px 14px;
  color: #fff;
  font-size: 14px;
  transition: border-color 0.2s;
}

.chat-input-bar input:focus {
  border-color: var(--accent);
  outline: none;
}

.chat-input-bar input:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  background: #111;
}

.chat-input-bar button {
  background: var(--accent);
  border: none;
  width: 42px;
  height: 42px;
  border-radius: 10px;
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s;
}

.chat-input-bar button:hover:not(:disabled) {
  background: #3a66e5;
  transform: scale(1.05);
}

/* UPLOAD BOT√ìN PROFESIONAL */
.upload-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  width: 42px;
  height: 42px;
  border-radius: 10px;
  color: var(--muted);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}
    .upload-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo">
          <img src="logo.png" alt="KHZ Logo">
        </div>
        <strong>KHZ Middleman Service</strong>
      </div>
      
      <div class="actions">
        <div id="enterTicketCode" style="display:flex; align-items:center; gap: 8px; background: rgba(255,255,255,0.03); padding: 4px 4px 4px 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.08);">
          <input type="text" id="ticketCodeInput" placeholder="Ticket code..." 
            style="width: 110px; border: none; background: transparent; color: white; font-size: 13px; font-weight: 500; outline: none;"/>
          <button id="joinTicketBtn" class="btn secondary" style="padding: 8px 14px; font-size: 12px; border-radius: 10px;">Join</button>
        </div>

        <a class="btn secondary" href="#reviews">Reviews</a>
        <button class="btn primary" id="createTicketBtn">Create Ticket</button>
        
        <button onclick="document.getElementById('middlemanLogin').style.display='flex'" 
                style="background:transparent; border:none; color:rgba(255,255,255,0.1); cursor:pointer; font-size:10px;">MM</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1>Secure middleman service for gaming and digital accounts</h1>
        <p>We protect buyers and sellers with secure procedures, manual verification, and clear communication.</p>
        <div style="display:flex; gap:12px; align-items:center;">
          <div style="width:12px; height:12px; border-radius:50%; background:var(--accent2); box-shadow: 0 0 10px var(--accent2);"></div>
          <span style="font-size:14px; font-weight:500; color:var(--accent2)">Verified Middleman Service Active</span>
        </div>
      </div>
      
      <div class="hero-card">
        <h3 style="margin-top:0; font-size:18px;">Supported Platforms</h3>
        <div class="games">
          <span class="pill">SWGOH</span>
          <span class="pill">Hypixel</span>
          <span class="pill">Destiny</span>
          <span class="pill">Pokemon GO</span>
          <span class="pill">Genshin Impact</span>
          <span class="pill">Valorant</span>
          <span class="pill">Twitch</span>
          <span class="pill">YouTube</span>
          <span class="pill" style="background:rgba(255,255,255,0.05)">+ More</span>
        </div>
        <p style="margin-top:20px; font-size:14px; opacity:0.8;">We handle all digital assets with bank-grade security protocols.</p>
      </div>
    </section>

    <section class="section how">
      <h2>How it works</h2>
      <p class="sub">Our battle-tested process for 100% secure trades.</p>

      <div class="how-grid">
        <div class="card">
          <div style="color:var(--accent); font-weight:800; font-size:24px; margin-bottom:10px;">01</div>
          <h3>Create & Share</h3>
          <p>Generate a secure ticket and share the unique code with the other party.</p>
        </div>

        <div class="card">
          <div style="color:var(--accent); font-weight:800; font-size:24px; margin-bottom:10px;">02</div>
          <h3>Confirm Terms</h3>
          <p>Both parties join the encrypted chat to finalize transaction details.</p>
        </div>

        <div class="card">
          <div style="color:var(--accent); font-weight:800; font-size:24px; margin-bottom:10px;">03</div>
          <h3>Verification</h3>
          <p>The seller submits account credentials for our manual verification process.</p>
        </div>

        <div class="card">
          <div style="color:var(--accent); font-weight:800; font-size:24px; margin-bottom:10px;">04</div>
          <h3>Payment</h3>
          <p>Buyer completes the payment once the account is secured in our vault.</p>
        </div>

        <div class="card">
          <div style="color:var(--accent); font-weight:800; font-size:24px; margin-bottom:10px;">05</div>
          <h3>Delivery</h3>
          <p>We transfer all security credentials directly to the buyer.</p>
        </div>

        <div class="card">
          <div style="color:var(--accent); font-weight:800; font-size:24px; margin-bottom:10px;">06</div>
          <h3>Release</h3>
          <p>Funds are released to the seller after the buyer confirms full access.</p>
        </div>
      </div>
    </section>

    <section id="reviews" class="section">
      <h2>Client reviews</h2>
      <p class="sub">Real feedback from our global trading community.</p>

      <div id="feedbackBarContainer" style="margin-bottom:30px;"></div>
      <div class="testimonials" id="reviewsContainer"></div>
      <div id="pagination" style="margin-top:30px;"></div>

      <div style="max-width:550px; margin:60px auto 0; background:var(--card); border:1px solid rgba(255,255,255,0.06); border-radius:20px; padding:32px; box-shadow:var(--shadow);">
        <h3 style="margin:0 0 8px; font-size:22px;">Leave a review</h3>
        <p style="color:var(--muted); font-size:14px; margin-bottom:24px;">Only verified clients can submit feedback.</p>
        
        <form id="reviewForm">
          <input type="text" id="reviewName" placeholder="Username" required 
            class="form-input" style="margin-bottom:12px;"/>
          
          <div id="quickReviews" style="display:flex; gap:8px; margin-bottom:12px; overflow-x:auto; padding-bottom:8px;"></div>
          
          <textarea id="reviewText" placeholder="Describe your experience..." required rows="4" 
            class="form-input" style="resize:none; margin-bottom:20px;"></textarea>
          
          <button type="submit" class="submit-btn">Post Verified Review</button>
        </form>
      </div>
    </section>
  </main>

  <section id="middlemanSection" class="section" style="display:none; background:rgba(43,212,189,0.02)">
    <div class="container">
      <h2><span style="color:var(--accent2)">‚óè</span> Active Master Tickets</h2>
      <div id="ticketList" class="grid"></div>
    </div>
  </section>

  <footer>
    <div class="container">
      <span>¬© <span class="year-range">2022‚Äì<span id="year"></span></span> KHZ Middleman Service.</span>
      <div style="display:flex; gap:20px; opacity:0.6;">
        <a href="#">Terms</a>
        <a href="#">Privacy</a>
      </div>
    </div>
  </footer>

  <div id="ticketPopup" class="chat-popup">
    <div class="popup-content">
      <div style="font-size:40px; margin-bottom:15px;">üé´</div>
      <p id="ticketText" style="font-size:16px; line-height:1.6;"></p>
      <button id="closePopup" class="btn primary" style="margin-top: 20px;">I Understand</button>
    </div>
  </div>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// Configuraci√≥n de Supabase
const SUPABASE_URL = 'https://hgzbdjumlzczwyrvmllz.supabase.co'
const SUPABASE_ANON_KEY = 'sb_publishable_K4lepgc7XUeYnz4PnkV6QA_Y3Xnr0WU'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

// ELEMENTOS DE LA INTERFAZ
const createTicketBtn = document.getElementById('createTicketBtn')
const chooseBuyer = document.getElementById('chooseBuyer')
const chooseSeller = document.getElementById('chooseSeller')
const rolePopup = document.getElementById('rolePopup')
const ticketPopup = document.getElementById('ticketPopup')
const closePopupBtn = document.getElementById('closePopup')

/**
 * Formateo est√©tico de los nombres en el chat (Estilo ElDorado)
 */
function formatSender(sender) {
  if (sender === 'middleman') {
    return `<span style="color:var(--accent2); font-weight:800; text-transform:uppercase; font-size:11px; letter-spacing:0.5px; display:block; margin-bottom:2px;">
              <span style="filter:drop-shadow(0 0 5px var(--accent2))">üõ°Ô∏è Official Middleman</span>
            </span>`
  }
  if (sender === 'buyer') {
    return `<span style="color:var(--accent); font-weight:700; font-size:11px; text-transform:uppercase; display:block; margin-bottom:2px;">
              üë§ Buyer
            </span>`
  }
  if (sender === 'seller') {
    return `<span style="color:#f59e0b; font-weight:700; font-size:11px; text-transform:uppercase; display:block; margin-bottom:2px;">
              üì¶ Seller
            </span>`
  }
  if (sender === 'connected') {
    return `<span style="color:#a855f7; font-weight:600; font-size:11px; display:block; margin-bottom:2px;">
              üü£ Counterparty
            </span>`
  }
  return `<span style="color:var(--muted); font-size:11px; display:block; margin-bottom:2px;">${sender}:</span>`
}

// ESTADO GLOBAL DE LA APLICACI√ìN
let currentTicketId = null
let currentRole = null
let chatChannel = null
let middlemanOnline = false
let chatInitialized = false  
let sendingMessage = false  
let middlemanInterval = null

/**
 * Resuelve y valida el rol del usuario basado en el ticket de la DB
 */
function resolveRoleFromTicket(ticket) {
  if (currentRole === "middleman") return "middleman";

  const savedRole = localStorage.getItem("khz_role");
  if (savedRole === "buyer" && ticket.buyer) return "buyer";
  if (savedRole === "seller" && ticket.seller) return "seller";

  // Asignaci√≥n autom√°tica inteligente
  if (ticket.buyer && !ticket.seller) return "seller";
  if (ticket.seller && !ticket.buyer) return "buyer";

  return "guest";
}

const MIDDLEMAN_KEY = "*Dinero19"

document.addEventListener('DOMContentLoaded', async () => {
  // ‚ôªÔ∏è Actualizar a√±o del footer autom√°ticamente
  const yearEl = document.getElementById('year');
  if (yearEl) yearEl.textContent = new Date().getFullYear();

  // ‚ôªÔ∏è Restaurar sesi√≥n existente de Supabase
  const savedTicket = localStorage.getItem("khz_ticketId");
  const savedRole = localStorage.getItem("khz_role");

  if (savedTicket && savedRole) {
    currentTicketId = savedTicket;
    currentRole = savedRole;

    const { data: ticket, error } = await supabase
      .from("tickets")
      .select("*")
      .eq("id", savedTicket)
      .single(); 

    if (!ticket || error) {
      console.warn("Session expired or ticket invalid.");
      localStorage.removeItem("khz_ticketId");
      localStorage.removeItem("khz_role");
      currentTicketId = null;
      currentRole = null;
    } else {
      currentRole = resolveRoleFromTicket(ticket);
      if (ticket.middleman_joined) middlemanOnline = true;
      
      // Mostrar banner de "Reanudar Operaci√≥n" de forma est√©tica
      showRestoreBanner(); 
    }
  }

  // Prevenir recarga en formularios de login
  const middlemanForm = document.getElementById("middlemanForm");
  if (middlemanForm) {
    middlemanForm.addEventListener("submit", e => e.preventDefault());
  }

  // ==========================================
  // L√ìGICA DE CREACI√ìN DE ORDEN (COMPRADOR)
  // ==========================================
  const createOrderBtn = document.getElementById("buyerCreateOrderBtn");
  if (createOrderBtn) {
    createOrderBtn.onclick = async () => {
      if (currentRole !== "buyer") {
        alert("Action restricted to Comprador only.");
        return;
      }

      if (!currentTicketId) return;

      const name = document.getElementById("buyerProductName").value.trim();
      const amount = document.getElementById("buyerAmount").value.trim();
      const currency = document.getElementById("buyerCurrency").value;

      if (!name || !amount) {
        alert("Please specify the product and the agreed price.");
        return;
      }

      // Actualizar ticket en Supabase con los detalles del trade
      const { error } = await supabase
        .from("tickets")
        .update({
          product_name: name,
          amount: amount,
          currency: currency,
          status_step: "PRODUCT_SET"
        })
        .eq("id", currentTicketId);

      if (error) {
        console.error("DB Error:", error);
        alert("Error creating order. Please try again.");
        return;
      }

      const { data: ticketData } = await supabase
        .from("tickets")
        .select("code")
        .eq("id", currentTicketId)
        .single();

      // Mostrar popup profesional con el c√≥digo generado
      document.getElementById("ticketText").innerHTML = `
        <div style="text-align:center">
          <div style="background:rgba(43,212,189,0.1); color:var(--accent2); padding:10px; border-radius:12px; display:inline-block; margin-bottom:15px; font-weight:bold;">
            ORDER SECURED ‚úÖ
          </div>
          <p style="color:var(--muted); font-size:14px; margin-bottom:20px;">
            Trade initialized. Share this unique access code with the seller:
          </p>
          <div style="background:#0b0f14; border:1px dashed var(--accent); padding:20px; border-radius:12px; font-size:28px; font-weight:800; letter-spacing:4px; color:#fff; position:relative;">
            ${ticketData.code}
          </div>
          <p style="font-size:12px; color:var(--muted); margin-top:15px;">The transaction will begin once the seller joins.</p>
        </div>
      `;

      ticketPopup.style.display = "flex";
      document.getElementById("buyerCreateOrderModal").style.display = "none";
      
      // Cargar panel de estado
      if (typeof loadOrderPanel === "function") loadOrderPanel(currentTicketId);
    };
  }

  // ATRAJO DE TECLADO PARA EL MIDDLEMAN (CTRL + M)
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === 'm') {
      e.preventDefault();
      const mmModal = document.getElementById('middlemanLogin');
      if (mmModal) mmModal.style.display = 'flex';
    }
  });
  // =====================
  // LOGIN MIDDLEMAN
  // =====================
  document.getElementById('middlemanLoginBtn').onclick = async () => {
    const input = document.getElementById('middlemanKeyInput');
    if (input.value === MIDDLEMAN_KEY) {
      currentRole = 'middleman';
      
      // Si ya hay un ticket activo, avisamos que el MM entr√≥
      if (currentTicketId) {
        await supabase
          .from("tickets")
          .update({ middleman_joined: true })
          .eq("id", currentTicketId);
      }

      document.getElementById('middlemanLogin').style.display = 'none';
      document.getElementById('middlemanSection').style.display = 'block';

      // Carga inicial y bucle de actualizaci√≥n de tickets abiertos
      loadMiddlemanTickets();
      if (middlemanInterval) clearInterval(middlemanInterval);
      middlemanInterval = setInterval(loadMiddlemanTickets, 5000);
    } else {
      alert("Invalid Access Key");
    }
  };

  // =====================
  // JOIN TICKET
  // =====================
  const joinTicketBtn = document.getElementById('joinTicketBtn');
  const ticketCodeInput = document.getElementById('ticketCodeInput');

  joinTicketBtn.addEventListener('click', async () => {
    const code = ticketCodeInput.value.trim().toUpperCase();
    if (!code) return alert("Please enter a valid ticket code");

    const { data: ticket, error } = await supabase
      .from('tickets')
      .select('*')
      .eq('code', code)
      .single();

    if (error || !ticket) return alert("Ticket not found. Verify the code.");

    currentTicketId = ticket.id;
    const resolvedRole = resolveRoleFromTicket(ticket);
    currentRole = resolvedRole;

    // Guardar en sesi√≥n local para reanudar si se recarga
    localStorage.setItem("khz_ticketId", currentTicketId);
    localStorage.setItem("khz_role", currentRole);

    // üîë REGISTRAR SELLER (Si es la primera vez que se une)
    if (resolvedRole === "seller" && !ticket.seller) {
      await supabase
        .from("tickets")
        .update({ seller: "connected" })
        .eq("id", ticket.id);
    }

    // L√ìGICA DE SINCRONIZACI√ìN DEL MIDDLEMAN
    if (resolvedRole === "middleman") {
      await supabase
        .from("tickets")
        .update({ middleman_joined: true })
        .eq("id", ticket.id);
      middlemanOnline = true;
    } else {
      middlemanOnline = ticket.middleman_joined || false;
    }

    // Aplicar bloqueos de chat si el MM no est√° presente
    applyChatPermissions(currentRole); 

    // Interfaz
    const joinTicketModal = document.getElementById('joinTicketModal');
    if (joinTicketModal) joinTicketModal.style.display = 'none';
    
    showChatSection();
    loadMessages();
    setupRealtime(); // Vital para ver cuando el MM entra en vivo
  });

  // =====================
  // CREATE TICKET (INICIO)
  // =====================
  createTicketBtn.addEventListener('click', () => {
    rolePopup.style.display = 'flex';
  });

}); // ‚úÖ CIERRE CORRECTO DOMContentLoaded DEL BLOQUE ANTERIOR


// =====================
// üîÑ FORCE MIDDLEMAN SYNC
// =====================
async function forceMiddlemanSync(ticketId) {
  const { data, error } = await supabase
    .from("tickets")
    .select("middleman_joined")
    .eq("id", ticketId)
    .single();

  if (error) return;

  if (data?.middleman_joined) {
    middlemanOnline = true;
    applyChatPermissions(currentRole);
  }
}

// ==========================================
// GENERADOR DE C√ìDIGOS √öNICOS
// ==========================================
function generateTicketID() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Quitamos O, 0, I, 1 por confusi√≥n
  let result = '';
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

// ==========================================
// NAVEGACI√ìN HACIA EL CHAT
// ==========================================
function showChatSection() {
  // Ocultamos el contenido principal (Hero, How it works, Reviews)
  const mainContent = document.querySelector('main');
  const chatOverlay = document.getElementById('chatOverlay');
  
  if (mainContent) mainContent.style.filter = 'blur(10px)';
  if (chatOverlay) chatOverlay.style.display = 'flex';
  
  // Cerramos modales de selecci√≥n
  if (document.getElementById('rolePopup')) rolePopup.style.display = 'none';
}

// ==========================================
// CREACI√ìN DE TICKET EN DATABASE
// ==========================================
async function createTicketWithRole(role) {
  const newTicket = {
    code: generateTicketID(), 
    status: "open",
    middleman_joined: false,
    created_at: new Date().toISOString()
  };

  const { data: ticket, error } = await supabase
    .from('tickets')
    .insert([newTicket])
    .select()
    .single();

  if (error) {
    console.error("Supabase Insert Error:", error);
    alert("Error creating ticket: " + error.message);
    return;
  }

  if (ticket) {
    currentTicketId = ticket.id;
    currentRole = role;
    middlemanOnline = false;

    // Persistencia
    localStorage.setItem("khz_ticketId", currentTicketId);
    localStorage.setItem("khz_role", currentRole);

    // Si es comprador, mostramos el modal de detalles del producto
    if (role === 'buyer') {
      document.getElementById('buyerCreateOrderModal').style.display = 'block';
    } else {
      // Si es vendedor, vamos directo al chat a esperar al comprador
      showChatSection();
      loadMessages();
      setupRealtime();
    }
    
    applyChatPermissions(currentRole);
  }
}

// ASIGNACI√ìN DE EVENTOS A LOS BOTONES DE ROL
if (chooseBuyer) {
  chooseBuyer.onclick = () => createTicketWithRole('buyer');
}

if (chooseSeller) {
  chooseSeller.onclick = () => createTicketWithRole('seller');
}

// CERRAR POPUP DE C√ìDIGO Y ENTRAR AL CHAT
if (closePopupBtn) {
  closePopupBtn.addEventListener('click', () => {
    ticketPopup.style.display = 'none';
    showChatSection();
    loadMessages();
    setupRealtime();
  });
}

  // ==========================================
// APERTURA DE VENTANA DE CHAT
// ==========================================
async function openChat(ticketId, role) {
  if (!ticketId || !role) return;

  currentTicketId = ticketId;
  currentRole = role;

  localStorage.setItem("khz_ticketId", ticketId);
  localStorage.setItem("khz_role", role);

  // Verificar si el Middleman ya est√° presente en la DB
  const { data: ticket } = await supabase
    .from("tickets")
    .select("middleman_joined")
    .eq("id", ticketId)
    .single();

  middlemanOnline = !!ticket?.middleman_joined;

  // UI Setup
  const overlay = document.getElementById("chatOverlay");
  const messagesBox = document.getElementById("messages"); // ID corregido seg√∫n tu CSS

  if (!overlay || !messagesBox) return;

  overlay.style.display = "flex";
  messagesBox.innerHTML = ""; // Limpiar antes de cargar

  // Aplicar permisos de escritura
  applyChatPermissions(currentRole);

  // Cargar historial y panel de estado
  await loadOldMessages();
  if (typeof loadOrderPanel === "function") await loadOrderPanel(ticketId);

  // Mensaje de sistema inicial
  if (!middlemanOnline && currentRole !== "middleman") {
    addSystemMessage("‚è≥ Waiting for middleman to secure the chat...");
  }
}

// ==========================================
// CARGA DE HISTORIAL (ESTILO ELDORADO)
// ==========================================
async function loadOldMessages() {
  if (!currentTicketId) return;

  const messagesBox = document.getElementById("messages");
  if (!messagesBox) return;

  const { data: messages, error } = await supabase
    .from("messages")
    .select("*")
    .eq("ticket_id", currentTicketId)
    .order("id", { ascending: true });

  if (error) {
    console.error("Load messages error:", error);
    return;
  }

  messages?.forEach(msg => {
    renderMessage(msg);
  });

  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// ==========================================
// RENDERIZADO DE BURBUJAS DE MENSAJE
// ==========================================
function renderMessage(msg) {
  const messagesBox = document.getElementById("messages");
  if (!messagesBox) return;

  const div = document.createElement("div");
  
  // Determinar la clase seg√∫n qui√©n env√≠a y qui√©n eres t√∫
  let bubbleClass = "msg them"; // Por defecto es "el otro"
  if (msg.sender === currentRole) bubbleClass = "msg me";
  if (msg.sender === "middleman") bubbleClass = "msg middleman";

  div.className = bubbleClass;

  if (msg.extension === "image") {
    div.innerHTML = `
      ${formatSender(msg.sender)}
      <img src="${msg.text}" style="max-width:100%; border-radius:10px; margin-top:5px; cursor:pointer;" onclick="window.open(this.src)">
    `;
  } else {
    div.innerHTML = `${formatSender(msg.sender)} <div>${msg.text}</div>`;
  }

  messagesBox.appendChild(div);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// ==========================================
// PERMISOS DE CHAT
// ==========================================
function applyChatPermissions(role) {
  const input = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendMsg");

  if (!input || !sendBtn) return;

  if (role === "middleman") {
    input.disabled = false;
    sendBtn.disabled = false;
    input.placeholder = "Write as Official Middleman...";
    return;
  }

  if (middlemanOnline) {
    input.disabled = false;
    sendBtn.disabled = false;
    input.placeholder = "Write a message...";
  } else {
    input.disabled = true;
    sendBtn.disabled = true;
    input.placeholder = "üîí Waiting for Middleman...";
  }
}

// ==========================================
// SISTEMA REALTIME (TICKETS Y MENSAJES)
// ==========================================
function setupRealtime() {
  // Canal para cambios en el Ticket (Saber cuando entra el MM)
  supabase
    .channel("ticket-updates")
    .on("postgres_changes", { event: "UPDATE", schema: "public", table: "tickets" }, 
    payload => {
      if (payload.new.id !== currentTicketId) return;

      if (payload.new.middleman_joined === true && !middlemanOnline) {
        middlemanOnline = true;
        addSystemMessage("‚úÖ Middleman joined. Chat unlocked.");
        applyChatPermissions(currentRole);
      }
    })
    .subscribe();

  // Canal para nuevos Mensajes
  supabase
    .channel("new-messages")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, 
    payload => {
      if (payload.new.ticket_id !== currentTicketId) return;
      renderMessage(payload.new);
    })
    .subscribe();
}

function addSystemMessage(text) {
  const messagesBox = document.getElementById("messages");
  if (!messagesBox) return;

  const div = document.createElement("div");
  div.style.cssText = "text-align:center; margin:15px 0; font-size:12px; color:var(--muted); width:100%; font-weight:600; text-transform:uppercase; letter-spacing:1px;";
  div.innerHTML = `‚Äî ${text} ‚Äî`;
  messagesBox.appendChild(div);
  messagesBox.scrollTop = messagesBox.scrollHeight;
}

// ==========================================
// ENV√çO DE MENSAJES
// ==========================================
if (!chatInitialized) {
  chatInitialized = true;
  
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendMsg");

  msgInput?.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendBtn.click();
    }
  });

  sendBtn.onclick = async () => {
    if (sendingMessage || !currentTicketId || !msgInput.value.trim()) return;

    sendingMessage = true;
    const text = msgInput.value.trim();
    msgInput.value = ""; // Limpiar r√°pido para mejor UX

    await supabase.from("messages").insert([{
      ticket_id: currentTicketId,
      sender: currentRole,
      text: text,
      topic: "chat",
      extension: "text"
    }]);

    sendingMessage = false;
  };
}

// BOTONES DE CIERRE Y REANUDACI√ìN
document.getElementById("closeChatBtn").onclick = () => {
  document.getElementById("chatOverlay").style.display = "none";
  document.querySelector('main').style.filter = 'none';
};

function showRestoreBanner() {
  const restoreBtn = document.getElementById("restoreChatBtn");
  if (!restoreBtn) return;

  restoreBtn.style.display = "flex";
  restoreBtn.onclick = () => {
    openChat(currentTicketId, currentRole);
    restoreBtn.style.display = "none";
  };
}
/* =====================
   UPLOAD PAYMENT PHOTO
   ===================== */
const paymentInput = document.getElementById("paymentPhotoInput")

paymentInput.addEventListener("change", async () => {

  if (!currentTicketId) {
    alert("Ticket not ready yet")
    paymentInput.value = ""
    return
  }

  const { data: ticket } = await supabase
    .from("tickets")
    .select("status_step")
    .eq("id", currentTicketId)
    .single();

  if (ticket.status_step !== "PRODUCT_SET") {
    alert("Order is not ready for payment yet.");
    paymentInput.value = "";
    return;
  }
  
  if (currentRole !== "buyer") {
    alert("Only the buyer can upload payment proof")
    paymentInput.value = ""
    return
  }

  const file = paymentInput.files[0]
  if (!file) return

  const fileName = `payments/${currentTicketId}_${Date.now()}_${file.name}`

  const { error: uploadError } = await supabase.storage
    .from("chat-files")
    .upload(fileName, file)

  if (uploadError) {
    console.error(uploadError)
    alert("Error uploading image")
    return
  }

  const { data } = supabase.storage
    .from("chat-files")
    .getPublicUrl(fileName)

  // üöÄ Insertar mensaje usando renderMessage para consistencia
  const newMessage = {
    ticket_id: currentTicketId,
    sender: currentRole,
    text: data.publicUrl,
    topic: "chat",
    extension: "image"
  };

  const { error } = await supabase.from("messages").insert([newMessage]);

  if (error) {
    console.error("INSERT IMAGE ERROR:", error)
    alert(error.message)
    return
  }

  // Actualizar orden (ESCROW)
  await supabase
    .from("tickets")
    .update({
      payment_proof: data.publicUrl,
      status_step: "PAYMENT_UPLOADED"
    })
    .eq("id", currentTicketId)

  document.getElementById("orderStatusText").textContent = "PAYMENT_UPLOADED"
  paymentInput.value = ""
})

/* =====================
   ‚ú® RENDER MESSAGE (PREMIUM)
   ===================== */
function renderMessage(msg) {
  const box = document.getElementById("messages");
  if (!box) return;

  const div = document.createElement("div");
  // A√±adimos una peque√±a animaci√≥n de entrada
  div.className = `msg ${msg.sender} animate-fade-in`;
  
  if (msg.extension === "image") {
    div.innerHTML = `
      <div class="msg-content">
        <span class="sender-tag">${msg.sender.toUpperCase()}</span>
        <div class="chat-img-wrapper">
          <img src="${msg.text}" class="chat-img-clickable" loading="lazy">
        </div>
      </div>
    `;
  } else {
    div.innerHTML = `
      <div class="msg-content">
        <span class="sender-tag">${msg.sender.toUpperCase()}</span>
        <p class="msg-text">${msg.text}</p>
      </div>
    `;
  }

  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* =====================
   üåå PREMIUM BLUR EFFECT
   ===================== */
function toggleAppBlur(active) {
  const mainContent = document.querySelector(".main-container"); // Ajusta a tu selector de fondo
  if (mainContent) {
    if (active) {
      mainContent.style.filter = "blur(10px) brightness(0.8)";
      mainContent.style.transition = "filter 0.3s ease";
    } else {
      mainContent.style.filter = "none";
    }
  }
}

// ORDER PANEL (ESCROW) - Mantenemos tu l√≥gica igual
// =====================
async function loadOrderPanel(ticketId) {
  const { data: ticket, error } = await supabase
    .from("tickets")
    .select("status_step, product_name, amount, currency")
    .eq("id", ticketId)
    .single()

  if (error || !ticket) {
    console.error("Order panel error:", error)
    return
  }

  const statusEl = document.getElementById("orderStatusText");
  if (statusEl) statusEl.textContent = ticket.status_step || "CREATED";

  renderOrderActions(ticket.status_step, currentRole)

  const productEl = document.getElementById("orderProductText");
  if (productEl) productEl.textContent = ticket.product_name || "‚Äî";

  const amountEl = document.getElementById("orderAmountText");
  if (amountEl) amountEl.textContent = `${ticket.currency || "$"} ${ticket.amount || "‚Äî"}`;

  // RESET Steps visuales
  document.querySelectorAll(".step").forEach(step => step.classList.remove("active", "done"))

  if (ticket.status_step === "CREATED") document.getElementById("step-payment").classList.add("active")
  if (ticket.status_step === "PAYMENT_UPLOADED") {
    document.getElementById("step-payment").classList.add("done")
    document.getElementById("step-delivery").classList.add("active")
  }
  if (ticket.status_step === "DELIVERED") {
    document.getElementById("step-payment").classList.add("done")
    document.getElementById("step-delivery").classList.add("done")
    document.getElementById("step-confirm").classList.add("active")
  }
  if (ticket.status_step === "RELEASED") {
    document.getElementById("step-payment").classList.add("done")
    document.getElementById("step-delivery").classList.add("done")
    document.getElementById("step-confirm").classList.add("done")
    document.getElementById("step-release").classList.add("active")
  }
  if (ticket.status_step === "COMPLETED") {
    document.querySelectorAll(".step").forEach(step => step.classList.add("done"))
  }
}

// ORDER ACTIONS - Tu l√≥gica original intacta
// =====================
function renderOrderActions(status, role) {
  const box = document.getElementById("orderActions");
  if (!box) return;
  box.innerHTML = "";

  if (role === "buyer" && status === "DELIVERED") {
    box.innerHTML = `<button id="btnConfirm" class="btn-premium">Confirm Delivery</button>`;
    document.getElementById("btnConfirm").onclick = () => updateTicketStatus("COMPLETED");
  }

  if (role === "seller") {
    if (status === "PAYMENT_CONFIRMED") {
      box.innerHTML = `<button id="btnDelivered" class="btn-premium">Mark as Delivered</button>`;
      document.getElementById("btnDelivered").onclick = () => updateTicketStatus("DELIVERED");
    } else {
      box.innerHTML = `<p style="color:#9aa4b2; font-size:12px">Waiting for payment confirmation</p>`;
    }
  }

  if (role === "middleman") {
    if (status === "PAYMENT_UPLOADED") {
      box.innerHTML = `<button id="btnConfirmPayment" class="btn-premium">Confirm Payment</button>`;
      document.getElementById("btnConfirmPayment").onclick = () => updateTicketStatus("PAYMENT_CONFIRMED");
    }
    if (status === "COMPLETED") {
      box.innerHTML = `<button id="btnRelease" class="btn-premium">Release Funds</button>`;
      document.getElementById("btnRelease").onclick = () => updateTicketStatus("RELEASED");
    }
  }
}
async function updateTicketStatus(newStatus) {
  const { error } = await supabase
    .from("tickets")
    .update({ status_step: newStatus })
    .eq("id", currentTicketId);

  if (error) {
    alert("Error updating status");
    console.error(error);
  } else {
    loadOrderPanel(currentTicketId); // Actualiza la vista del ticket
  }
}

// =====================
// MIDDLEMAN TICKETS LIST
// =====================
async function loadMiddlemanTickets() {
  const { data: tickets, error } = await supabase
    .from('tickets')
    .select('*')
    .order('id', { ascending: false });

  if (error) {
    console.error(error);
    return;
  }

  const list = document.getElementById('ticketList');
  if (!list) return;

  list.innerHTML = '';

  tickets?.forEach(t => {
    const div = document.createElement('div');
    // A√±adimos una clase para estilos premium en el listado
    div.className = "ticket-card-premium"; 
    
    const btn = document.createElement('button');
    btn.textContent = 'Open';
    btn.className = "btn-open-chat";
    btn.onclick = () => {
      openChat(t.id, 'middleman');
      toggleAppBlur(true); // Activa el desenfoque al abrir
    };

    div.innerHTML = `
      <div class="ticket-info">
        <strong>${t.code}</strong><br>
        <span class="status-badge">${t.status_step || t.status}</span><br>
        <small>B: ${t.buyer || '‚Äî'} | S: ${t.seller || '‚Äî'}</small>
      </div>
    `;

    div.appendChild(btn);
    list.appendChild(div);
  });
}

if (currentRole === 'middleman') {
  loadMiddlemanTickets();
  middlemanInterval = setInterval(loadMiddlemanTickets, 3000);
}

// =====================
// MINIMIZAR / RESTAURAR CHAT
// =====================
const minimizeBtn = document.getElementById('minimizeChatBtn');
const restoreBtn = document.getElementById('restoreChatBtn');
const chatOverlay = document.getElementById('chatOverlay');

if (minimizeBtn && restoreBtn && chatOverlay) {
  minimizeBtn.onclick = () => {
    chatOverlay.style.display = 'none';
    restoreBtn.style.display = 'block';
    toggleAppBlur(false); // Quita el blur al minimizar
  };

  restoreBtn.onclick = () => {
    chatOverlay.style.display = 'flex';
    restoreBtn.style.display = 'none';
    toggleAppBlur(true); // Re-activa el blur al restaurar
  };
}

// =====================
// IMAGE MODAL (LOGICA UNIFICADA)
// =====================
document.addEventListener("click", (e) => {
  let src = null;
  const img = e.target.closest("img");
  
  // Evitamos abrir el modal con avatars o perfiles
  if (img && !img.classList.contains("avatar") && !img.closest(".profile")) {
    src = img.src;
  }

  if (!src) {
    const el = e.target.closest("[style*='background-image']");
    if (el) {
      const bg = el.style.backgroundImage;
      src = bg.slice(5, -2).replace(/"/g, "");
    }
  }

  if (!src) return;

  const modal = document.getElementById("imageModal");
  const modalImg = document.getElementById("modalImage");
  
  if (modal && modalImg) {
    modal.style.display = "flex";
    modalImg.src = src;
    // Efecto extra de profundidad al ver la imagen
    modal.style.backdropFilter = "blur(15px)";
  }
});

// Evento de cierre del Chat con Confirmaci√≥n
const closeChatBtn = document.getElementById("closeChatBtn");
if (closeChatBtn) {
  closeChatBtn.onclick = () => {
    const userConfirmed = window.confirm("Are you sure you want to close the chat? All messages will be lost.");
    if (userConfirmed) {
      document.getElementById("chatOverlay").style.display = "none";
      toggleAppBlur(false); // Limpiamos el fondo
    }
  };
}

// Manejo del modal de imagen (Cerrar)
const imgModal = document.getElementById("imageModal");
const closeImgBtn = document.querySelector("#imageModal .close");

if (closeImgBtn) {
  closeImgBtn.onclick = () => {
    imgModal.style.display = "none";
  };
}

if (imgModal) {
  imgModal.onclick = (e) => {
    if (e.target === imgModal) {
      imgModal.style.display = "none";
    }
  };
}

</script>
  
<script type="module">


import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore,
  collection,
  getDocs,
  addDoc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA8Nhp0i8GCZSTq8aWcWicmOTAizz1JxEU",
  authDomain: "services-mm.firebaseapp.com",
  projectId: "services-mm",
  storageBucket: "services-mm.firebasestorage.app",
  messagingSenderId: "659049911622",
  appId: "1:659049911622:web:e14a5e00e0efde7af0c147"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const reviewsRef = collection(db, "reviews");

const container = document.getElementById('reviewsContainer');
const pagination = document.getElementById('pagination');
const feedbackBarContainer = document.getElementById('feedbackBarContainer');

let reviews = [];
let currentPage = 1;

// Cargar rese√±as de Firebase
async function loadReviews() {
  const q = query(reviewsRef, orderBy("date", "desc"));
  const snapshot = await getDocs(q);
  reviews = snapshot.docs.map(doc => doc.data());
  render();
}

// Utilidades
function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function formatDate(d) {
  return new Date(d.seconds ? d.seconds*1000 : d)
    .toLocaleDateString('en-US', {year:'numeric', month:'short', day:'numeric'});
}

// Resumen feedback
function updateFeedbackSummary() {
  const total = reviews.length;
  const verifiedCount = reviews.filter(r => r.verified).length;

  let percent = total ? Math.round((verifiedCount / total) * 100) : 0;
  if (percent > 97) percent = 97;

  feedbackBarContainer.innerHTML = `
    <div style="font-size:12px;margin-bottom:4px;">
      <span style="color:#3b82f6;">üëç 97%</span>
      &nbsp;&nbsp;
      <span style="color:#ef4444;">üëé 3%</span>
    </div>
    <div style="font-weight:600;font-size:20px;margin-bottom:6px;">783 total transactions</div>
    <div style="margin-top:6px;background:#0f1628;height:12px;border-radius:6px;overflow:hidden;">
      <div style="width:${percent}%;height:100%;background:#2bd4bd;"></div>
    </div>
  `;
}

// Quick reviews
function renderQuickReviews(){
  const box = document.getElementById("quickReviews");
  if(!box) return;
  box.innerHTML = "";

  const firstTwoPages = reviews.slice(0,84);
  const count = {};

  firstTwoPages.forEach(r=>{
    const t = r.text.trim();
    count[t] = (count[t]||0)+1;
  });

  Object.entries(count)
    .filter(([_,c])=>c>1)
    .slice(0,10)
    .forEach(([text])=>{
      const b = document.createElement("button");
      b.type="button";
      b.className="btn secondary";
      b.style.fontSize="11px";
      b.style.padding="6px 8px";
      b.textContent = text.length>40 ? text.slice(0,40)+"‚Ä¶" : text;
      b.onclick = ()=>document.getElementById("reviewText").value=text;
      box.appendChild(b);
    });
}

// Render rese√±as
function render() {
  container.innerHTML = "";

  const perPage = currentPage === 1 ? 36 : 48;
  const start = currentPage === 1 ? 0 : 36 + (currentPage-2)*48;
  const pageItems = reviews.slice(start, start + perPage);

  let pendingCount = 0;

  pageItems.forEach(r => {
    if (!r.verified) {
      if (pendingCount >= 1) return;
      pendingCount++;
    }

    const div = document.createElement('div');
    div.className = 'review';
    div.innerHTML = `
      <div class="profile">
        <img class="avatar" src="https://i.pravatar.cc/80?u=${r.name}" />
        <div>
          <div class="name">${escapeHTML(r.name)}</div>
          <div class="date">${formatDate(r.date)}</div>
        </div>
      </div>
      ${r.verified
        ? '<div class="verified">&#10004; Verified transaction</div>'
        : '<div class="verified" style="color:#facc15;border-color:#facc15;background:rgba(250,204,21,.1)">&#9203; Pending verification</div>'}
      <p>${escapeHTML(r.text)}</p>
    `;
    container.appendChild(div);
  });

  renderPagination();
  updateFeedbackSummary();
}

// Paginaci√≥n
function renderPagination() {
  pagination.innerHTML = '';
  const totalPages = Math.ceil(Math.max(0, reviews.length-36)/48) + 1;

  if(currentPage > 1) {
    const prev = document.createElement('button');
    prev.className = 'btn secondary';
    prev.textContent = 'Previous';
    prev.onclick = ()=>{ currentPage--; render(); };
    pagination.appendChild(prev);
  }

  if(currentPage < totalPages) {
    const next = document.createElement('button');
    next.className = 'btn secondary';
    next.textContent = 'Next';
    next.onclick = ()=>{ currentPage++; render(); };
    pagination.appendChild(next);
    renderQuickReviews();
  }
}

// Nueva rese√±a
const form = document.getElementById('reviewForm');
form.addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('reviewName').value.trim();
  const text = document.getElementById('reviewText').value.trim();
  if(!name || !text) return;

  const newReview = { name, text, date: new Date(), verified: false };
  reviews.unshift(newReview);
  render();
  await addDoc(reviewsRef, newReview);
  form.reset();
  currentPage = 1;
});

document.getElementById('year').textContent = new Date().getFullYear();
loadReviews();

</script>

<div id="rolePopup" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.75); /* Un poco m√°s oscuro para resaltar el popup */
  backdrop-filter: blur(8px); /* Efecto blur de fondo premium */
  z-index:10000;
  align-items:center;
  justify-content:center;
">
  <div style="
    background:#121826;
    border-radius:20px;
    padding:26px;
    width:340px;
    text-align:center;
    box-shadow:0 20px 50px rgba(0,0,0,.6);
    border: 1px solid rgba(255,255,255,0.05); /* Borde sutil */
  ">
    <h3 style="margin-top:0; color:#fff;">Select your role</h3>
    <p style="color:#9aa4b2;font-size:14px">
      Choose how you participate in this transaction
    </p>

    <div style="display:flex; gap:14px; margin-top:20px">
      <button id="chooseBuyer" class="btn" style="flex:1">Buyer</button>
      <button id="chooseSeller" class="btn secondary" style="flex:1">Seller</button>
    </div>
  </div>
</div>

<div id="chatOverlay" class="chat-overlay">
  <div class="chat-window">

    <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <div style="width: 8px; height: 8px; background: #2bd4bd; border-radius: 50%; box-shadow: 0 0 8px #2bd4bd;"></div>
        <strong>Live Chat</strong>
      </div>
      <div class="chat-header-actions">
        <button id="minimizeChatBtn" style="background:none; border:none; color:#9aa4b2; cursor:pointer;">_</button>
        <button id="closeChatBtn" style="background:none; border:none; color:#9aa4b2; cursor:pointer; font-size:16px;">‚úï</button>
      </div>
    </div>

    <div id="orderPanel" style="background: rgba(15, 22, 40, 0.6); border-bottom: 1px solid rgba(255,255,255,0.05);">
      <div class="order-info">
        <div>
          <span class="label">Product</span>
          <span id="orderProductText" style="color: #fff; font-weight: 500;">‚Äî</span>
        </div>
        <div>
          <span class="label">Amount</span>
          <span id="orderAmountText" style="color: #2bd4bd; font-weight: 600;">‚Äî</span>
        </div>
      </div>

      <div id="orderSteps">
        <span class="step" id="step-payment">Payment</span>
        <span class="step" id="step-delivery">Delivery</span>
        <span class="step" id="step-confirm">Confirm</span>
        <span class="step" id="step-release">Released</span>
      </div>

      <div id="orderActions"></div>
    </div>

    <div id="messages" class="chat-messages" style="scrollbar-width: thin; scrollbar-color: #1e2a4a transparent;"></div>

    <div class="chat-input-bar" style="background: #0f1628; border-top: 1px solid rgba(255,255,255,0.05); padding: 12px; gap: 10px;">
      
      <label class="upload-btn" style="margin: 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; transition: 0.3s;">
        üì∑
        <input type="file" id="paymentPhotoInput" accept="image/*" hidden>
      </label>

      <input id="msgInput" placeholder="Write a message..." style="flex: 1; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; padding: 8px 12px;" />
      
      <button id="sendMsg" style="background: #3b82f6; border: none; border-radius: 10px; padding: 8px 15px; color: #fff; font-weight: 600; cursor: pointer;">Send</button>
    </div>

  </div>
</div>


<button id="restoreChatBtn" style="
  display:none;
  position:fixed;
  bottom:20px;
  right:20px;
  background:#1e2a4a;
  color:white;
  border:none;
  border-radius:20px;
  padding:10px 16px;
  cursor:pointer;
  box-shadow:0 10px 20px rgba(0,0,0,.4);
  z-index: 9999;
">
  üí¨ Chat
</button>

<div id="imageModal" class="image-modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="modalImage">
</div>

<div id="buyerCreateOrderModal" class="chat-popup" style="display:none; backdrop-filter: blur(10px);">
  <div class="popup-content" style="background: #121826; border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
    <h3 style="color:#fff; margin-bottom: 20px;">Create Order</h3>

    <input
      id="buyerProductName"
      class="chat-input"
      placeholder="Product / Account name"
      style="margin-bottom: 12px;"
    />

    <input
      id="buyerAmount"
      class="chat-input"
      type="number"
      placeholder="Price"
      style="margin-bottom: 12px;"
    />

    <select id="buyerCurrency" class="chat-input" style="margin-bottom: 20px;">
      <option value="USD">$ USD</option>
      <option value="EUR">‚Ç¨ EUR</option>
      <option value="GBP">¬£ GBP</option>
    </select>

    <button id="buyerCreateOrderBtn" class="btn primary" style="width: 100%;">
      Create Order
    </button>
  </div>
</div>

<div id="middlemanLogin" class="modal" style="display:none; backdrop-filter: blur(15px);">
  <div class="modal-content" style="background: #121826; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">
    <span class="close-btn" onclick="document.getElementById('middlemanLogin').style.display='none'">&times;</span>
    <h3 style="color:#fff;">Middleman Access</h3>

   <form onsubmit="document.getElementById('middlemanLoginBtn').click(); return false;">
  <input
    type="text"
    name="username"
    autocomplete="username"
    style="display:none"
  >

  <input
    id="middlemanKeyInput"
    class="form-input"
    type="password"
    placeholder="Enter middleman key"
    autocomplete="new-password"
    style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 12px; width: 100%; color: #fff;"
  />
</form>

    <button id="middlemanLoginBtn" class="submit-btn" style="margin-top: 20px; width: 100%; border-radius: 10px;">
      Enter
    </button>
  </div>
</div>

</body>
</html>






























